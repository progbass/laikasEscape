define(["underscore","backbone","Alien","Astronaut","ScoreDisplay","LifeBar","ModalWindow","easel","preload","sound","tween"],function(e,t,s,i,a,n,o){var h=t.View.extend({root:this,font:"Bowlby One SC",canvas:"game_canvas",stage:null,container:null,preload:null,images:[],defaultWidth:1280,defaultHeight:768,defaultRatio:0,actualWidth:0,actualHeight:0,width:0,height:0,ratio:0,pixelRatio:1,stageScale:1,user_agent:null,enemies_config:["img/alien1.png","img/alien2.png","img/alien3.png","img/blood.png"],enemies_int_min:0,enemies_int_max:0,enemies_int_min_default:900,enemies_int_max_default:1500,enemies_minInterval:680,enemies_nextTime:0,enemies_simultaneous:0,enemies_max_simultaneous:4,enemiesCount:0,enemiesSmashed:0,enemies_combo_flag:!1,enemies_combo_hits:0,enemies_combo_min:2,enemies_combo_delay:1e3,enemies_combo_newTime:0,enemies_combo_applause:3,astronaut:null,astronaut_generate:!0,astronaut_int_min:1800,astronaut_int_max:3500,astronaut_nextTime:0,level:1,holes_number:6,holes_used:[],holes_masks:[],pause_btn:null,pause:!1,pause_x:120,pause_y:57,isGameRunning:!1,stopUpdating:!1,music:null,music_max_volume:.5,mute_btn:null,mute_flag:!0,muting_active:!1,mute_x:60,mute_y:57,life_bar:null,stopLifeBar:!1,score_display:null,smashed_text:null,initialize:function(){var t=this;e.bindAll(this,"tick","startGame","gameOver","playNextLevel","theEnd","pauseGame","showAstronaut","showEnemy","getFreeHole","onResize","configTabVisibility","resizeCanvas","handleFileComplete","handleFileLoad","setupCanvasResolution"),this.stage=new createjs.Stage(this.canvas),createjs.Touch.enable(this.stage),this.setupCanvasResolution(),this.loadAssets()},loadAssets:function(){this.preload=new createjs.LoadQueue(!0),this.preload.installPlugin(createjs.Sound),createjs.Sound.alternateExtensions=["mp3","ogg"],this.preload.on("fileload",this.handleFileLoad),this.preload.on("complete",this.handleFileComplete),this.preload.on("error",this.handleError),this.preload.on("fileprogress",this.handleFileProgress),this.preload.on("progress",this.handleProgress),this.preload.loadFile({id:"bg",src:"img/icon_alien.png"}),this.preload.loadFile({id:"pauseSprite",src:"img/pause.png"});for(var e=0;e<this.enemies_config.length;e++)this.preload.loadFile({id:"alien"+e,src:this.enemies_config[e]});this.preload.loadFile({id:"astronaut",src:"img/astronaut.png"}),this.preload.loadFile({id:"modalWindow",src:"img/modalWindow_sprite.png"}),this.preload.loadFile({id:"muteSprite",src:"img/mute.png"}),this.preload.loadFile({id:"musicFX",src:"sound/LaikasEscape.mp3"}),this.preload.loadFile({id:"fx_flan",src:"sound/flan.mp3"}),this.preload.loadFile({id:"fx_fly",src:"sound/fly.mp3"}),this.preload.loadFile({id:"fx_worm",src:"sound/worm.mp3"}),this.preload.loadFile({id:"fx_smash1",src:"sound/smash_1.mp3"}),this.preload.loadFile({id:"fx_smash2",src:"sound/smash_2.mp3"}),this.preload.loadFile({id:"fx_hurt",src:"sound/hurt.mp3"}),this.preload.loadFile({id:"laikaGroan",src:"sound/laika_groan.mp3"}),this.preload.loadFile({id:"gameOver",src:"sound/game_over.mp3"}),this.preload.loadFile({id:"combo",src:"sound/ding.mp3"}),this.preload.loadFile({id:"applause",src:"sound/applause.mp3"}),this.preload.loadFile({id:"admiration",src:"sound/ooooh.mp3"})},handleFileLoad:function(e){},handleError:function(e){},handleFileProgress:function(e){},handleProgress:function(e){var t=Math.round(100*e.loaded),s=document.getElementById("progressbar"),i=s.getElementsByClassName("percent")[0];i.innerHTML="Loading "+t+"%";var a=s.getElementsByClassName("bar")[0];a.style.width=t+"%"},handleFileComplete:function(){var e=this,t=document.getElementById("progressbar");$(t).fadeOut(),this.container=new createjs.Container,this.container.x=0,this.container.y=0,this.stage.addChild(this.container);var s=new createjs.Graphics;s.f("rgba(150,198,221,254)").p("EA9aAR0Mg3KAAAMAAAAs2IMMAAYAAAKAAAUAAAUYAKC0FoAoImA8YDwAeEsgyCWg8YD6huBahGAehGIMCAAMAAAgs2").cp().ef();var i=new createjs.Graphics;i.f("rgba(150,198,221,254)").p("EA4GAR0MAAAAwwIMCAAYAADSI6CqLGAAYLGAAI6iqAAjSIJYAAMAAAgwwMg9aAAA").cp().ef();var n=new createjs.Graphics;n.f("rgba(150,198,221,254)").p("ECpOARqMg1cAAAMAAAAsYILaAAYAKAUAUAUAUAUYCWBkEOCMIcAAYISAAG4iMAAigIAAAAILGAAMAAAgsY").cp().ef();var o=new createjs.Graphics;o.f("rgba(150,198,221,254)").p("EBMkAjUMg+qAAAMAAAA0+IJsAAYAUDIE2DILuAAYFKAAImAADwg8YFohQDmiWAehuII6AAMAAAg0+").cp().ef();var h=new createjs.Graphics;h.f("rgba(150,198,221,254)").p("ECU6AmcMhKiAAAMAAAA6mIMMAAYAoDSKKC+NIAAYH+AAJsg8E2hkYDIhGCghaAohQIJsAAMAAAg6m").cp().ef();var r=new createjs.Graphics;r.f("rgba(150,198,221,254)").p("EDBmAjUMg9kAAAMAAAAwSIJiAAYAeBuC+A8C+A8YDcBQFAAUFKAAYJsAKH+iMB4jIIMgAAMAAAgwS").cp().ef();var l=new createjs.Shape(s),d=new createjs.Shape(i),u=new createjs.Shape(n),m=new createjs.Shape(o),c=new createjs.Shape(h),_=new createjs.Shape(r);this.holes_masks.push(l,d,u,m,c,_);for(var p=0;6>p;p++)var g=this.holes_masks[p];this.score_display=new a,this.score_display.sprite.x=this.stage.canvas.width-.1*this.stage.canvas.width,this.score_display.sprite.y=50,this.stage.addChild(this.score_display.sprite),this.smashed_text=new createjs.Text("","46px "+e.font,"#FA8C14"),this.smashed_text.y=180,this.smashed_text.x=this.width/2,this.smashed_text.regY=this.smashed_text.getMeasuredHeight()/2,this.smashed_text.alpha=0,this.smashed_text.scaleX=this.smashed_text.scaleY=0,this.configAstronaut(),this.configLifeBar(),this.configModalWindow();var f=new createjs.SpriteSheet({images:[this.preload.getResult("pauseSprite")],frames:[[0,0,50,50,0,25,25],[50,0,50,50,0,25,25]]});this.pause_btn=new createjs.Sprite(f),this.pause_btn.alpha=0,this.pause_btn.x=this.pause_x,this.pause_btn.y=this.pause_y,this.pause_btn.on("click",function(){e.pauseGame()}),this.stage.addChild(this.pause_btn);var A=new createjs.SpriteSheet({images:[this.preload.getResult("muteSprite")],frames:[[0,0,50,50,0,25,25],[50,0,50,50,0,25,25]]});this.mute_btn=new createjs.Sprite(A),this.mute_btn.alpha=0,this.mute_btn.y=this.mute_y,this.mute_btn.x=this.mute_x,this.mute_btn.on("click",function(){e.muting_active=!0,e.mute_btn.gotoAndStop(e.mute_flag?1:0),e.mute_flag=!e.mute_flag}),this.stage.addChild(this.mute_btn),this.render(),this.configTabVisibility(),this.reset(),window.addEventListener("resize",this.onResize,!1),e.onResize(),this.modalWindow.show()},configModalWindow:function(){var e=this;e.modalWindow=new o,e.modalWindow.sprite.x=Math.round(e.width/2),e.stage.addChild(e.modalWindow.sprite),e.modalWindow.sprite.on("click",function(){e.modalWindow.hide(),setTimeout(e.startGame,600,e),e.mute_btn.alpha=1,e.music=createjs.Sound.play("musicFX","none",0,0,-1,e.music_max_volume)})},configLifeBar:function(){var e=this;e.life_bar=new n,e.life_bar.sprite.x=e.width/2-e.life_bar.width/2,e.life_bar.sprite.y=120,e.life_bar.sprite.alpha=0,e.life_bar.on("madeIt",function(){e.isGameRunning&&e.playNextLevel()}),e.life_bar.on("timeUp",function(){setTimeout(e.gameOver,200)}),e.stage.addChild(e.life_bar.sprite)},configAstronaut:function(){var e=this;this.astronaut=new i,this.astronaut.on("dead",this.gameOver),this.astronaut.on("hit",function(){if(this.getLifes()>0){var t=new createjs.Text(this.getLifes(),"40px "+e.font,"#FF0000");t.y=this.sprite.y-120,t.x=this.sprite.x,t.regX=t.getMeasuredWidth()/2,t.regY=t.getMeasuredHeight()/2,t.alpha=0,t.scaleX=t.scaleY=0,e.stage.addChild(t),createjs.Tween.get(t).to({alpha:1,scaleX:1,scaleY:1},100,createjs.Ease.quartOut).wait(100).to({y:t.y-30,alpha:0},240,createjs.Ease.quartIn).call(function(){e.stage.removeChild(t)})}}),this.astronaut.on("gone",function(){e.astronaut_generate=!0,e.holes_used.splice(e.holes_used.indexOf(this.hole),1),e.container.removeChild(this.sprite)})},startGame:function(){this.clearAll(),this.isGameRunning=!0,this.astronaut_generate=!0,this.astronaut_nextTime=createjs.Ticker.getTime(!0)+this.getRandomInt(this.astronaut_int_min,this.astronaut_int_max),this.life_bar.reset(),this.stopLifeBar=!1,createjs.Tween.get(this.pause_btn,{override:!0}).to({alpha:1},200,createjs.Ease.easeOut),createjs.Tween.get(this.life_bar.sprite,{override:!0}).to({alpha:1},200,createjs.Ease.easeOut)},gameOver:function(){var e=this;this.isGameRunning=!1,this.stopLifeBar=!0,createjs.Tween.get(this.pause_btn,{override:!0}).to({alpha:0},200,createjs.Ease.easeOut),createjs.Tween.get(this.life_bar.sprite,{override:!0}).to({alpha:0},200,createjs.Ease.easeOut),this.modalWindow.setWindow("gameOver"),this.modalWindow.show();var t=e.modalWindow.sprite;e.container.removeChild(e.astronaut.sprite),e.stage.addChild(e.astronaut.sprite),e.astronaut.gotoFrame("ghost"),e.astronaut.removeListeners(),e.astronaut.sprite.mask=null,e.astronaut.sprite.alpha=0,createjs.Tween.get(e.astronaut.sprite,{override:!0}).set({x:t.x-225,y:e.height/2+25,scaleX:.7,scaleY:.7}).wait(800).to({alpha:1,y:e.height/2},1e3,createjs.Ease.quartInOut),setTimeout(function(){createjs.Sound.play("gameOver"),createjs.Sound.play("laikaGroan"),e.smashed_text.text="You killed "+e.enemiesSmashed+" aliens",e.smashed_text.regX=e.smashed_text.getMeasuredWidth()/2,e.stage.addChild(e.smashed_text),createjs.Tween.get(e.smashed_text).wait(800).to({alpha:1,scaleX:1,scaleY:1},320,createjs.Ease.backOut),e.modalWindow.sprite.on("click",function(){e.enemiesSmashed=0,createjs.Tween.get(e.smashed_text).to({alpha:.1,scaleX:0,scaleY:0},240,createjs.Ease.backIn).call(function(){e.stage.removeChild(e.smashed_text)}),e.modalWindow.hide(),createjs.Tween.get(e.astronaut.sprite,{override:!0}).to({alpha:0,y:e.stage.canvas.height/2-60},380,createjs.Ease.quadIn),setTimeout(function(){e.stage.removeChild(e.astronaut.sprite),e.container.addChild(e.astronaut.sprite),e.reset(),e.startGame()},800)})},1e3)},theEnd:function(){},playNextLevel:function(){var e=this;this.clearAll(),this.stopLifeBar=!0,createjs.Ticker.setPaused(!0),createjs.Tween.get(this.pause_btn,{override:!0}).to({alpha:0},200,createjs.Ease.easeOut),createjs.Tween.get(this.life_bar.sprite,{override:!0}).to({alpha:0},200,createjs.Ease.easeOut),this.level++,this.enemies_int_min-=120,this.enemies_int_max-=180,this.astronaut_int_min-=100,this.astronaut_int_max-=100,this.enemies_simultaneous+=this.level%4===0?1:0,this.enemies_int_min<=this.enemies_minInterval&&(this.enemies_int_min=this.enemies_minInterval),this.enemies_int_max<=this.enemies_minInterval+600&&(this.enemies_int_max=this.enemies_minInterval+600),this.astronaut_int_min<=10&&(this.astronaut_int_min=10),this.astronaut_int_max<=80&&(this.astronaut_int_max=80),this.enemies_simultaneous>=this.enemies_max_simultaneous&&(this.enemies_simultaneous=this.enemies_max_simultaneous),this.modalWindow.setWindow("level","Level "+this.level),this.modalWindow.on("click",function(){return!1}),this.modalWindow.show(),setTimeout(function(){e.modalWindow.hide(),createjs.Ticker.setPaused(!1),setTimeout(e.startGame,1e3)},1500)},reset:function(){this.clearAll(),this.astronaut.reset(),this.enemies_int_min=this.enemies_int_min_default,this.enemies_int_max=this.enemies_int_max_default,this.enemies_simultaneous=0,this.enemies_nextTime=0,this.astronaut_nextTime=0,this.level=1,this.score_display.reset(),this.holes_used=[]},getFreeHole:function(){for(var e=this,t=[],s=0;s<e.holes_number;s++)-1===e.holes_used.indexOf(s)&&t.push(s);return t.length?t[Math.floor(Math.random()*t.length)]:-1},clearAll:function(){this.enemiesCount=0,this.resetComboSettings()},pauseGame:function(e){var t=this;t.isGameRunning&&(this.pause=e||!this.pause,this.pause?(createjs.Ticker.setPaused(!0),this.modalWindow.setWindow("pause"),this.modalWindow.show(),this.modalWindow.sprite.on("click",function(){t.pauseGame(!1)}),setTimeout(function(){this.stopUpdating=!0},1200)):(createjs.Ticker.setPaused(!1),this.stopUpdating=!1,this.modalWindow.hide()))},showAstronaut:function(){var e=this,t=this.getFreeHole();return-1===t?!1:(e.holes_used.push(t),e.container.addChild(e.astronaut.sprite),e.container.setChildIndex(e.astronaut.sprite,t),void e.astronaut.setHole(t,e.holes_masks[t]))},showEnemy:function(){var e=this,t=this.getFreeHole();if(-1===t)return!1;e.holes_used.push(t);var i=new s;i.index=e.enemiesCount++,i.on("hit",function(){var t=this.sprite.getBounds();e.life_bar.slowEnemy(4),e.enemiesSmashed++,e.enemies_combo_flag?e.enemies_combo_hits++:(e.enemies_combo_newTime=createjs.Ticker.getTime(!0)+e.enemies_combo_delay,e.enemies_combo_flag=!0,e.enemies_combo_hits++);var s=e.isComboHit();if(e.isComboHit()){createjs.Sound.play("combo"),e.score_display.update(this.score_value*s);var i=new createjs.Text("Combo "+s+"x","50px "+e.font,"#ee2233");i.y=this.sprite.y-t.height/2,i.x=this.sprite.x-22,i.regX=i.getMeasuredWidth()/2,i.regY=i.getMeasuredHeight()/2,i.alpha=0,i.scaleX=i.scaleY=0,e.stage.addChild(i),createjs.Tween.get(i).to({alpha:1,scaleX:1,scaleY:1},100,createjs.Ease.backInOut).wait(240).to({y:i.y-140,alpha:0},320,createjs.Ease.quartIn).call(function(){e.stage.removeChild(i)})}else{e.score_display.update(this.score_value);var a=new createjs.Text("+"+this.score_value,"40px "+e.font,"#FA8C14");a.y=this.sprite.y-(t.height/2+20),a.x=this.sprite.x-a.getMeasuredWidth()/2,a.regX=a.getMeasuredWidth()/2,a.regY=a.getMeasuredHeight()/2,a.alpha=0,a.scaleX=a.scaleY=0,e.stage.addChild(a),createjs.Tween.get(a).to({alpha:1,scaleX:1,scaleY:1},100,createjs.Ease.quartOut).wait(100).to({y:a.y-30,alpha:0},240,createjs.Ease.quartIn).call(function(){e.stage.removeChild(a)})}}),i.on("miss",function(){e.life_bar.speedEnemy(4)}),i.on("enemyGone",function(){e.holes_used.splice(e.holes_used.indexOf(this.hole),1),e.container.removeChild(this.sprite)}),e.container.addChild(i.sprite),e.container.setChildIndex(i.sprite,t),i.setHole(t,e.holes_masks[t])},isComboHit:function(){return this.enemies_combo_hits>=this.enemies_combo_min?this.enemies_combo_hits-this.enemies_combo_min:!1},resetComboSettings:function(){this.enemies_combo_flag=!1,this.enemies_combo_hits=0},render:function(){createjs.Ticker.useRAF=!0,createjs.Ticker.setFPS(30),createjs.Ticker.addEventListener("tick",this.tick)},tick:function(e){if(this.muting_active){var t=this.mute_flag?.04:-.04;this.music.volume+=t,this.music.volume>=this.music_max_volume?(this.music.volume=this.music_max_volume,this.muting_active=!1):this.music.volume<=0&&(this.music.volume=0,this.muting_active=!1)}if(!e.paused&&this.isGameRunning){var s=createjs.Ticker.getTime(!0);if(this.enemies_nextTime<s){this.enemies_nextTime=s+this.getRandomInt(this.enemies_int_min,this.enemies_int_max);for(var i=1+Math.round(Math.random()*this.enemies_simultaneous),a=0;i>a;a++)this.showEnemy()}this.astronaut_nextTime<s&&this.astronaut_generate&&(this.astronaut_nextTime=s+this.getRandomInt(this.astronaut_int_min,this.astronaut_int_max),this.astronaut_generate=!1,this.showAstronaut()),this.enemies_combo_flag&&this.enemies_combo_newTime<s&&(this.enemies_combo_hits>this.enemies_combo_applause&&(createjs.Sound.play("applause"),this.enemies_combo_hits>this.enemies_combo_applause+1&&createjs.Sound.play("admiration")),this.resetComboSettings()),this.stopLifeBar||this.life_bar.update()}this.stopUpdating||this.stage.update()},setupCanvasResolution:function(){this.defaultWidth=1280,this.defaultHeight=768,this.defaultRatio=this.defaultWidth/this.defaultHeight;var e=this.stage.canvas.getContext("2d"),t=window.devicePixelRatio||1,s=e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1;this.pixelRatio=t/s},resizeCanvas:function(){var e=parseInt(this.stage.canvas.style.width,10)/this.defaultWidth,t=this.defaultHeight/(this.defaultHeight*e),s=parseInt(this.stage.canvas.style.height,10)*t;this.width=this.defaultWidth,this.height=Math.round(s),this.stageScale=this.stage.canvas.width/this.defaultWidth,this.stage.scaleX=this.stage.scaleY=this.stageScale;var i=window.innerWidth/window.innerHeight;i<this.defaultRatio&&(this.pause||this.pauseGame(!0))},onResize:function(){this.resizeCanvas(),this.modalWindow.redraw(this.width,this.height),this.modalWindow.sprite.x=this.defaultWidth/2,this.score_display.sprite.x=1100,this.smashed_text.x=this.width/2,this.life_bar.sprite.x=this.defaultWidth/2-this.life_bar.width/2,this.user_agent=navigator.userAgent.toLowerCase(),this.android=this.user_agent.indexOf("android")>-1?!0:!1,this.ios=this.user_agent.indexOf("iphone")>-1||this.user_agent.indexOf("ipad")>-1?!0:!1,this.android||this.ios,window.setTimeout(function(){window.scrollTo(0,1)},1),innerWidth<768?(this.mute_btn.scaleX=1.75,this.mute_btn.scaleY=1.75,this.mute_btn.x=this.mute_x+20,this.mute_btn.y=this.mute_y+30,this.pause_btn.scaleX=1.75,this.pause_btn.scaleY=1.75,this.pause_btn.x=this.pause_x+60,this.pause_btn.y=this.pause_y+30):(this.mute_btn.scaleX=1,this.mute_btn.scaleY=1,this.mute_btn.x=this.mute_x,this.mute_btn.y=this.mute_y,this.pause_btn.scaleX=1,this.pause_btn.scaleY=1,this.pause_btn.x=this.pause_x,this.pause_btn.y=this.pause_y)},configTabVisibility:function(){var e=this,t=e.getPrefix(),s="hidden",i="visibilitychange";t&&(s=t+"Hidden"),t&&(i=t+"visibilitychange"),document.addEventListener(i,function(){document[s]?(e.pauseGame(!0),e.music&&e.music.stop()):setTimeout(function(){e.music&&e.music.play()},800)},!1)},getPrefix:function(){if("hidden"in document)return null;for(var e=["moz","ms","o","webkit"],t=0;t<e.length;t++){var s=e[t]+"Hidden";if(s in document)return e[t]}return null},getRandomInt:function(e,t){return Math.floor(Math.random()*(t-e+1))+e}});return h});